#!/usr/bin/env python3

from pwn import *
from decoder import DecoderIntf
from Crypto.Cipher import AES

context.arch = 'arm'

def conn():
    r = DecoderIntf('/dev/ttyACM0')

    return r


def main():
    r = conn()

    # leaked with exploit
    secret_key = b's;\x85\x1c\x03\x82\xd9\xf2,X\x8a-\x0eS++'
    c = AES.new(secret_key, AES.MODE_ECB)

    device_id = 0xb804d98f

    c2_sub = c.encrypt(p32(device_id) + p64(0) + p64(2**64 - 1) + p32(2) + p64(0))
    c4_sub = c.encrypt(p32(device_id) + p64(0) + p64(2**64 - 1) + p32(4) + p64(0))

    c2_packet = bytes.fromhex('e5bbbcc67e15d9f7aab3d54d588656af90037fafaeb25238cbbb06cb205aa7c44620533a0f624b546e3e2e29fab2808f7ed0d9b60fdb66cc7c6dee42da10cb9e5f5c0b169f0bf563e17583b3969080df')
    c4_packet = bytes.fromhex('d2bf2ef9d952dbb1985b0928c73e25eec031a61b590265c597a69864eff80bd0f318911146832ed57136fbacaf9b204b6a393f554ac963344178104d453b33edb81a2d264f23d8c39677bcdfbd54b398')

    r.subscribe(c2_sub)
    r.subscribe(c4_sub)

    print(r.decode(c2_packet))
    print(r.decode(c4_packet))


    # payload = bytes.fromhex('c120f8c2b5499467587aba26440a0689907cb1e199d4deb10267cb86887b24045797e65d9ff8b3f2079611c3e536a345a1d97128f2d62d232cd902e13ee9cd41438e20958dedf408909a7a5aa38e009f')
    # data_own = bytes.fromhex('68f27d959ae383d4da2c3a9be0bed091945a90ba641714706202a6cf69691fc0')

    # r.subscribe(data_own)
    # print(r.decode(payload))

    # bad_sub = bytes.fromhex('68f27d959ae383d4da2c3a9be0bed09195580ce827dc0ddf945c9734c3899691')
    # r.subscribe(bad_sub)
    # pirate_packet = bytes.fromhex('943c5718db83ba3d90713906d9bb42bef2fafec9552a0539b2da0dffc8e01df77f0f3d1ff22051bed28cf973d49f8332a36b91351252f3b1000b0aee0a304358fc82c735fa14bf1a4c752e47dbb55529')
    # print(r.decode(pirate_packet))



if __name__ == "__main__":
    main()
